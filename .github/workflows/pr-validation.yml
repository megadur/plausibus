name: Pull Request Validation

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_PATH: './ErezeptValidator/ErezeptValidator.sln'

jobs:
  pr-validation:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}
      
    - name: Build application
      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Debug --no-restore
      
    - name: Run tests
      run: dotnet test ${{ env.SOLUTION_PATH }} --configuration Debug --no-build --verbosity normal
      
    # Uncomment and configure SonarCloud if needed
    # - name: Analyze code with SonarCloud
    #   uses: SonarSource/sonarcloud-github-action@master
    #   env:
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      
    - name: Check code formatting
      run: dotnet format ${{ env.SOLUTION_PATH }} --verify-no-changes --verbosity diagnostic
      
    - name: Security scan
      run: dotnet list package --vulnerable --include-transitive

  pr-size-check:
    runs-on: ubuntu-latest
    steps:
    - name: Check PR size
      uses: actions/github-script@v7
      with:
        script: |
          const pr = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          const additions = pr.data.additions;
          const deletions = pr.data.deletions;
          const changes = additions + deletions;
          
          if (changes > 1000) {
            core.setFailed(`PR is too large (${changes} lines changed). Consider splitting into smaller PRs.`);
          } else if (changes > 500) {
            console.log(`⚠️ Large PR detected (${changes} lines changed). Consider splitting if possible.`);
          } else {
            console.log(`✅ PR size is reasonable (${changes} lines changed).`);
          }