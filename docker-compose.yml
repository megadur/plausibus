# E-Rezept Validator - Docker Compose Configuration
# Uses existing PostgreSQL container (erezept-postgres)

version: '3.8'

services:
  # E-Rezept Validator API
  api:
    build:
      context: ./ErezeptValidator
      dockerfile: Dockerfile
    container_name: erezept-validator-api
    environment:
      # PostgreSQL connection to EXISTING container
      # Using host.docker.internal to connect to PostgreSQL on host
      ConnectionStrings__Ta1ReferenceDatabase: "Host=host.docker.internal;Port=5432;Database=erezept_validator;Username=erezept_user;Password=Segelboot.1;Pooling=true;Minimum Pool Size=1;Maximum Pool Size=20;Connection Lifetime=300;Timeout=30"

      # ABDATA connection (using credentials from appsettings.json)
      ConnectionStrings__AbdataDatabase: "Data Source=host.docker.internal;Initial Catalog=ABDATA1225A;User ID=sa;Password=Segelboot.1;Pooling=True;Connect Timeout=30;Encrypt=True;Trust Server Certificate=True;Authentication=SqlPassword;Application Name=ErezeptValidator"

      # Application settings
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080

      # ABDATA settings
      AbdataSettings__DatabaseName: ABDATA1225A
      AbdataSettings__Version: December 2025 A
      AbdataSettings__CacheExpirationHours: 24
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    extra_hosts:
      # Allows container to reach host services (PostgreSQL, ABDATA)
      - "host.docker.internal:host-gateway"
