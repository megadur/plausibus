# E-Rezept Validator - Docker Compose Configuration
# Runs API + PostgreSQL in Docker Desktop

version: '3.8'

services:
  # PostgreSQL database for TA1 reference data
  postgres:
    image: postgres:16-alpine
    container_name: erezept-postgres
    environment:
      POSTGRES_DB: erezept_validator
      POSTGRES_USER: erezept_user
      POSTGRES_PASSWORD: Segelboot.1
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U erezept_user -d erezept_validator"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - erezept-network

  # E-Rezept Validator API
  api:
    build:
      context: ./ErezeptValidator
      dockerfile: Dockerfile
    container_name: erezept-validator-api
    environment:
      # PostgreSQL connection
      ConnectionStrings__Ta1ReferenceDatabase: "Host=postgres;Port=5432;Database=erezept_validator;Username=erezept_user;Password=Segelboot.1;Pooling=true;Minimum Pool Size=1;Maximum Pool Size=20;Connection Lifetime=300;Timeout=30"

      # ABDATA connection (update with your SQL Server details)
      ConnectionStrings__AbdataDatabase: "Data Source=host.docker.internal;Initial Catalog=ABDATA1225A;User ID=sa;Password=YourPassword;TrustServerCertificate=true;Connection Timeout=30"

      # Application settings
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080

      # ABDATA settings
      AbdataSettings__DatabaseName: ABDATA1225A
      AbdataSettings__Version: December 2025 A
      AbdataSettings__CacheExpirationHours: 24
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - erezept-network

volumes:
  postgres_data:
    driver: local

networks:
  erezept-network:
    driver: bridge
