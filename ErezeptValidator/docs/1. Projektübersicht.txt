Perfekt! Du mÃ¶chtest einen **REST-API-Service in .NET 8 mit C#**, der **elektronische Rezepte (eRezepte) validiert** â€“ und das **konform mit gesetzlichen Vorgaben (gematik, SGB V, AMVV, BtMG, DSGVO)**. Hier ist eine **komplette, produktionsnahe Umsetzung** mit Best Practices, Struktur, Code-Beispielen und Integration in die Telematikinfrastruktur.

---

## ProjektÃ¼bersicht: `ErezeptValidator.Api`

```
ErezeptValidator.Api/
â”œâ”€â”€ Controllers/
â”‚   â””â”€â”€ ErezeptController.cs
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ ErezeptDto.cs
â”‚   â””â”€â”€ ValidationResultDto.cs
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ IErezeptValidationService.cs
â”‚   â””â”€â”€ ErezeptValidationService.cs
â”œâ”€â”€ Rules/
â”‚   â”œâ”€â”€ IValidationRule.cs
â”‚   â”œâ”€â”€ PznValidationRule.cs
â”‚   â”œâ”€â”€ DosageValidationRule.cs
â”‚   â””â”€â”€ BtmValidationRule.cs
â”œâ”€â”€ Infrastructure/
â”‚   â”œâ”€â”€ AbdaClient.cs
â”‚   â””â”€â”€ FhirParser.cs
â”œâ”€â”€ appsettings.json
â””â”€â”€ Program.cs
```

---

## 1. Projekt anlegen (.NET 8)

```bash
dotnet new webapi -n ErezeptValidator.Api
cd ErezeptValidator.Api
dotnet add package FHIR
dotnet add package Microsoft.Extensions.Http
dotnet add package System.Text.Json
```

> **FHIR-Package**: `dotnet add package Hl7.Fhir.R4` (fÃ¼r FHIR R4 â€“ gematik-Standard)

---

## 2. DTOs (Data Transfer Objects)

```csharp
// Models/ErezeptDto.cs
public record ErezeptDto(
    string PatientId,
    string ArztLanr,
    string Pzn,
    string Medikamentenname,
    double Menge,
    string Einheit,
    string Dosierung,
    bool IstBtm,
    DateTime Ausstellungsdatum,
    string? Diagnose = null
);

// Models/ValidationResultDto.cs
public record ValidationResultDto(
    bool IsValid,
    List<string> Errors,
    List<string> Warnings
);
```

---

## 3. REST API Controller

```csharp
// Controllers/ErezeptController.cs
[ApiController]
[Route("api/[controller]")]
public class ErezeptController : ControllerBase
{
    private readonly IErezeptValidationService _validator;

    public ErezeptController(IErezeptValidationService validator)
    {
        _validator = validator;
    }

    [HttpPost("validate")]
    public async Task<ActionResult<ValidationResultDto>> Validate([FromBody] ErezeptDto erezept)
    {
        if (!ModelState.IsValid)
            return BadRequest(new ValidationResultDto(false, ModelState.Values.SelectMany(v => v.Errors.Select(e => e.ErrorMessage)).ToList(), []));

        var result = await _validator.ValidateAsync(erezept);
        return Ok(result);
    }
}
```

---

## 4. Validierungs-Engine (Rule Engine Pattern)

```csharp
// Rules/IValidationRule.cs
public interface IValidationRule
{
    Task<(bool IsValid, string Error, string? Warning)> Validate(ErezeptDto erezept);
}

// Rules/PznValidationRule.cs
public class PznValidationRule : IValidationRule
{
    private readonly HttpClient _httpClient;

    public PznValidationRule(IHttpClientFactory factory)
    {
        _httpClient = factory.CreateClient("AbdaApi");
    }

    public async Task<(bool, string, string?)> Validate(ErezeptDto erezept)
    {
        if (!Regex.IsMatch(erezept.Pzn, @"^\d{8}$"))
            return (false, "PZN muss 8-stellig sein.", null);

        try
        {
            var response = await _httpClient.GetAsync($"/pzn/{erezept.Pzn}");
            if (!response.IsSuccessStatusCode)
                return (false, $"PZN {erezept.Pzn} nicht gefunden (ABDA).", null);

            var data = await response.Content.ReadFromJsonAsync<PznResponse>();
            if (data?.Zulassung == "nicht zugelassen")
                return (false, $"Medikament mit PZN {erezept.Pzn} ist nicht zugelassen.", null);
        }
        catch
        {
            return (false, "ABDA-API nicht erreichbar.", "PZN-PrÃ¼fung fehlgeschlagen â€“ Offline-Modus?");
        }

        return (true, "", null);
    }
}
```

> **Hinweis**: `PznResponse` ist ein DTO fÃ¼r die ABDA-Antwort (z. B. Lauer-Taxe API).

---

## 5. Weitere Regeln (Beispiele)

```csharp
// Rules/DosageValidationRule.cs
public class DosageValidationRule : IValidationRule
{
    private static readonly Dictionary<string, double> MaxTagesdosen = new()
    {
        ["Paracetamol"] = 4000, // mg
        ["Ibuprofen"] = 2400
    };

    public Task<(bool, string, string?)> Validate(ErezeptDto erezept)
    {
        if (MaxTagesdosen.TryGetValue(erezept.Medikamentenname, out var max))
        {
            // Einfaches Parsing: "500 mg 3x tÃ¤glich" â†’ 1500 mg
            var match = Regex.Match(erezept.Dosierung, @"(\d+)\s*mg.*?(\d)x", RegexOptions.IgnoreCase);
            if (match.Success)
            {
                var dosis = double.Parse(match.Groups[1].Value);
                var anzahl = int.Parse(match.Groups[2].Value);
                if (dosis * anzahl > max)
                    return (false, $"Tagesdosis Ã¼berschreitet {max} mg (AMVV).", null);
            }
        }
        return (true, "", null);
    }
}

// Rules/BtmValidationRule.cs
public class BtmValidationRule : IValidationRule
{
    public Task<(bool, string, string?)> Validate(ErezeptDto erezept)
    {
        if (erezept.IstBtm)
        {
            if (erezept.Ausstellungsdatum.AddDays(7) < DateTime.Today)
                return (false, "BtM-Rezept Ã¤lter als 7 Tage â€“ ungÃ¼ltig (BtMG Â§ 3).", null);
            if (string.IsNullOrWhiteSpace(erezept.Diagnose))
                return (false, "Bei BtM muss Diagnose angegeben sein.", null);
        }
        return (true, "", null);
    }
}
```

---

## 6. Service mit Rule Engine

```csharp
// Services/IErezeptValidationService.cs
public interface IErezeptValidationService
{
    Task<ValidationResultDto> ValidateAsync(ErezeptDto erezept);
}

// Services/ErezeptValidationService.cs
public class ErezeptValidationService : IErezeptValidationService
{
    private readonly IEnumerable<IValidationRule> _rules;

    public ErezeptValidationService(IEnumerable<IValidationRule> rules)
    {
        _rules = rules;
    }

    public async Task<ValidationResultDto> ValidateAsync(ErezeptDto erezept)
    {
        var errors = new List<string>();
        var warnings = new List<string>();

        foreach (var rule in _rules)
        {
            var (isValid, error, warning) = await rule.Validate(erezept);
            if (!isValid) errors.Add(error);
            if (warning != null) warnings.Add(warning);
        }

        return new ValidationResultDto(
            IsValid: errors.Count == 0,
            Errors: errors,
            Warnings: warnings
        );
    }
}
```

---

## 7. `Program.cs` â€“ DI & HTTP Client

```csharp
var builder = WebApplication.CreateBuilder(args);

// FHIR
builder.Services.AddSingleton<FhirJsonParser>();

// HTTP Clients
builder.Services.AddHttpClient("AbdaApi", client =>
{
    client.BaseAddress = new Uri("https://api.lauer-taxe.de/v1/");
    client.DefaultRequestHeaders.Add("Authorization", "Bearer YOUR_ABDA_TOKEN");
});

// Regeln
builder.Services.AddScoped<IValidationRule, PznValidationRule>();
builder.Services.AddScoped<IValidationRule, DosageValidationRule>();
builder.Services.AddScoped<IValidationRule, BtmValidationRule>();

// Service
builder.Services.AddScoped<IErezeptValidationService, ErezeptValidationService>();

// Controller
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

var app = builder.Build();

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();
app.MapControllers();

app.Run();
```

---

## 8. Beispiel-Request (Postman / curl)

```json
POST /api/erezept/validate
{
  "patientId": "X123456789",
  "arztLanr": "123456789",
  "pzn": "12345678",
  "medikamentenname": "Paracetamol",
  "menge": 30,
  "einheit": "Tabletten",
  "dosierung": "500 mg 3x tÃ¤glich",
  "istBtm": false,
  "ausstellungsdatum": "2025-11-01"
}
```

**Antwort:**
```json
{
  "isValid": false,
  "errors": ["Tagesdosis Ã¼berschreitet 4000 mg (AMVV)."],
  "warnings": []
}
```

---

## 9. Telematikinfrastruktur (TI) â€“ NÃ¤chster Schritt

FÃ¼r **produktiven Einsatz** musst du:

| Aufgabe | LÃ¶sung |
|-------|--------|
| **TI-Anbindung** | SMC-B Karte + Konnektor (z. B. KoCoBox) |
| **Authentifizierung** | eGK + HBA des Arztes |
| **FHIR aus TI** | Nutze `gematik eRezept Fachdienst` (REST-API) |
| **Zertifikat** | Software muss gematik-zertifiziert sein |

**Tipp**: Starte mit **Mock-TI** (gematik stellt Testumgebung bereit).

---

## 10. Deployment & Sicherheit

- **Docker**: Containerisieren
- **Azure / AWS**: Mit Managed Identity + Key Vault
- **Logging**: Serilog + Seq (DSGVO-konform)
- **Rate Limiting**: `AspNetCoreRateLimit`
- **Zertifikat**: TLS 1.3, HSTS

---

## Fazit: Dein Plan

| Schritt | Aktion |
|-------|--------|
| 1 | Projekt mit .NET 8 anlegen |
| 2 | DTOs + Controller |
| 3 | Rule Engine mit 3â€“5 Regeln |
| 4 | ABDA API integrieren (Test-Token beantragen) |
| 5 | Unit-Tests mit xUnit |
| 6 | Swagger + Docker |
| 7 | gematik kontaktieren fÃ¼r TI-Zulassung |

---

## Bonus: Unit Test (Beispiel)

```csharp
[Fact]
public async Task Validate_BtmRezeptOhneDiagnose_Fehler()
{
    var dto = new ErezeptDto(..., istBtm: true, diagnose: null);
    var result = await _service.ValidateAsync(dto);
    Assert.False(result.IsValid);
    Assert.Contains("Diagnose", result.Errors[0]);
}
```

---

Wenn du mÃ¶chtest, kann ich dir:
- Ein **komplettes GitHub-Repo** als ZIP generieren
- Die **ABDA-API-Integration mit echtem Token** zeigen
- Eine **FHIR-Parsing-Engine aus KBV-Snippet** bauen
- Oder die **gematik TI-Anbindung** mit Mock-Service

Sag einfach Bescheid â€“ ich helfe dir bis zur Produktion! ðŸš€